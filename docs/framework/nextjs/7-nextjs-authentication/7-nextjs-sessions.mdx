---
title: Next.js Sessions
description: Learn how to implement and manage sessions in Next.js applications for secure user authentication

---

# Next.js Sessions

Sessions are a crucial mechanism for maintaining user state in web applications. In this guide, we'll explore how to implement and manage sessions in Next.js applications, providing you with the knowledge to build secure and user-friendly authentication systems.

## What are Sessions?

A session is a way to store information about a user across multiple requests to your website. Unlike cookies, which store data on the client side, sessions typically store a reference on the client (a session ID) while keeping the actual data on the server.

In Next.js applications, sessions are commonly used to:

- Keep users authenticated after logging in
- Store user preferences
- Track user activities
- Implement authorization mechanisms

## Session Flow in Next.js

Here's a typical session flow in a Next.js application:

1. User logs in with credentials
2. Server validates credentials and creates a session
3. Server sends a session identifier (usually in a cookie)
4. On subsequent requests, the session identifier is sent to the server
5. Server looks up the session data and determines if the user is authenticated

## Implementing Sessions in Next.js

Let's explore different approaches to implement sessions in Next.js:

### 1. Using next-auth for Session Management

[NextAuth.js](https://next-auth.js.org/) is a popular authentication library for Next.js that provides built-in session management.

First, install NextAuth:

```bash
npm install next-auth
# or
yarn add next-auth
```

#### Basic Setup

Create an API route at `pages/api/auth/[...nextauth].js`:

```javascript
import NextAuth from 'next-auth';
import Providers from 'next-auth/providers';

export default NextAuth({
  providers: [
    Providers.Credentials({
      name: 'Credentials',
      credentials: {
        username: { label: "Username", type: "text" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // Add your authentication logic here
        if (credentials.username === "admin" && credentials.password === "password") {
          return { id: 1, name: "Admin User", email: "admin@example.com" };
        } else {
          return null;
        }
      }
    })
  ],
  session: {
    jwt: true,
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  callbacks: {
    async session(session, user) {
      // Add custom session properties if needed
      session.userId = user.id;
      return session;
    }
  }
});
```

#### Using Sessions in Components

```jsx
import { useSession, signIn, signOut } from "next-auth/client";

export default function Component() {
  const [session, loading] = useSession();

  if (loading) {
    return <p>Loading...</p>;
  }

  if (session) {
    return (
      <>
        <p>Signed in as {session.user.email}</p>
        <button onClick={() => signOut()}>Sign out</button>
      </>
    );
  } else {
    return (
      <>
        <p>Not signed in</p>
        <button onClick={() => signIn()}>Sign in</button>
      </>
    );
  }
}
```

### 2. Using Iron Session for Custom Session Management

Iron Session is a popular library for encrypted, stateless session management.

```bash
npm install iron-session
# or
yarn add iron-session
```

#### Create a Session Configuration

Create a file called `lib/session.js`:

```javascript
import { withIronSession } from 'next-iron-session';

export function withSession(handler) {
  return withIronSession(handler, {
    password: process.env.SECRET_COOKIE_PASSWORD,
    cookieName: 'next-app-session',
    cookieOptions: {
      // secure should be enabled in production
      secure: process.env.NODE_ENV === 'production',
      maxAge: 60 * 60 * 24 * 7, // 1 week
    },
  });
}
```

Make sure to add a strong, at least 32 characters long secret to your `.env.local` file:

```
SECRET_COOKIE_PASSWORD=complex_password_at_least_32_characters_long
```

#### Creating a Login API Route

Create an API route at `pages/api/login.js`:

```javascript
import { withSession } from '../../lib/session';

export default withSession(async (req, res) => {
  if (req.method === 'POST') {
    const { username, password } = req.body;

    // Validate credentials (this is a simplified example)
    if (username === 'admin' && password === 'password') {
      // Set the user in the session
      req.session.user = {
        id: 1,
        username: 'admin',
        admin: true,
      };
      await req.session.save();
      return res.status(200).json({ message: 'Logged in successfully' });
    }

    return res.status(403).json({ message: 'Invalid credentials' });
  }
  
  return res.status(405).json({ message: 'Method not allowed' });
});
```

#### Creating a User API Route

Create an API route at `pages/api/user.js` to fetch the current user session:

```javascript
import { withSession } from '../../lib/session';

export default withSession(async (req, res) => {
  const user = req.session.user;

  if (user) {
    // The user is authenticated
    res.status(200).json({ user });
  } else {
    // Not authenticated
    res.status(401).json({ message: 'Not authenticated' });
  }
});
```

#### Creating a Logout API Route

Create an API route at `pages/api/logout.js`:

```javascript
import { withSession } from '../../lib/session';

export default withSession(async (req, res) => {
  req.session.destroy();
  res.status(200).json({ message: 'Logged out successfully' });
});
```

#### Using Sessions in a Component

```jsx
import { useState, useEffect } from 'react';
import { useRouter } from 'next/router';

export default function LoginPage() {
  const router = useRouter();
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');

  async function handleSubmit(e) {
    e.preventDefault();
    
    const response = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    
    if (response.ok) {
      router.push('/dashboard');
    } else {
      alert('Login failed');
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <label>
        Username:
        <input 
          type="text" 
          value={username} 
          onChange={(e) => setUsername(e.target.value)} 
        />
      </label>
      <label>
        Password:
        <input 
          type="password" 
          value={password} 
          onChange={(e) => setPassword(e.target.value)} 
        />
      </label>
      <button type="submit">Login</button>
    </form>
  );
}
```

## Session Security Best Practices

When implementing sessions in Next.js, follow these security best practices:

1. **Use HTTPS**: Always serve your application over HTTPS to prevent session hijacking.

2. **Set Proper Cookie Flags**:
   - `HttpOnly`: Prevents JavaScript access to cookies
   - `Secure`: Ensures cookies are sent only over HTTPS
   - `SameSite`: Controls when cookies are sent with cross-site requests

3. **Session Timeout**: Implement a reasonable session timeout to limit the window of opportunity for attacks.

4. **CSRF Protection**: Implement Cross-Site Request Forgery protection to prevent unauthorized commands from being executed.

5. **Rate Limiting**: Implement rate limiting on login attempts to prevent brute force attacks.

6. **Session Regeneration**: Regenerate session IDs after authentication to prevent session fixation attacks.

## Example: Protected Routes with Iron Session

Here's how to create protected routes using Iron Session:

```jsx
// components/withAuth.js
import { useEffect } from 'react';
import { useRouter } from 'next/router';

export function withAuth(Component) {
  return function AuthenticatedComponent(props) {
    const router = useRouter();
    const { user } = props;

    useEffect(() => {
      if (!user) {
        router.push('/login');
      }
    }, [user]);

    if (!user) {
      return <div>Loading...</div>;
    }

    return <Component {...props} />;
  };
}
```

Using the `withAuth` HOC in a page:

```jsx
// pages/dashboard.js
import { withSession } from '../lib/session';
import { withAuth } from '../components/withAuth';

function Dashboard({ user }) {
  return (
    <div>
      <h1>Dashboard</h1>
      <p>Welcome, {user.username}!</p>
    </div>
  );
}

export const getServerSideProps = withSession(async function ({ req }) {
  const user = req.session.user;
  
  if (!user) {
    return {
      redirect: {
        destination: '/login',
        permanent: false,
      },
    };
  }
  
  return {
    props: { user },
  };
});

export default withAuth(Dashboard);
```

## Real-world Example: Shopping Cart with Sessions

Let's implement a simple shopping cart that persists between page navigations using sessions:

```javascript
// pages/api/cart.js
import { withSession } from '../../lib/session';

export default withSession(async (req, res) => {
  // Initialize cart if it doesn't exist
  if (!req.session.cart) {
    req.session.cart = [];
  }

  switch (req.method) {
    case 'GET':
      return res.json({ cart: req.session.cart });
      
    case 'POST':
      const { id, name, price, quantity } = req.body;
      
      // Check if item already exists in cart
      const existingItemIndex = req.session.cart.findIndex(item => item.id === id);
      
      if (existingItemIndex > -1) {
        // Update quantity if item already exists
        req.session.cart[existingItemIndex].quantity += quantity;
      } else {
        // Add new item
        req.session.cart.push({ id, name, price, quantity });
      }
      
      await req.session.save();
      return res.status(200).json({ cart: req.session.cart });
      
    case 'DELETE':
      const { itemId } = req.body;
      req.session.cart = req.session.cart.filter(item => item.id !== itemId);
      await req.session.save();
      return res.status(200).json({ cart: req.session.cart });
      
    default:
      return res.status(405).json({ message: 'Method not allowed' });
  }
});
```

Using the shopping cart in a component:

```jsx
// components/ShoppingCart.js
import { useState, useEffect } from 'react';

export default function ShoppingCart() {
  const [cart, setCart] = useState([]);
  const [loading, setLoading] = useState(true);

  // Fetch cart on component mount
  useEffect(() => {
    async function fetchCart() {
      const res = await fetch('/api/cart');
      const data = await res.json();
      setCart(data.cart);
      setLoading(false);
    }
    
    fetchCart();
  }, []);

  async function addToCart(product) {
    const res = await fetch('/api/cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(product),
    });
    
    const data = await res.json();
    setCart(data.cart);
  }

  async function removeFromCart(itemId) {
    const res = await fetch('/api/cart', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ itemId }),
    });
    
    const data = await res.json();
    setCart(data.cart);
  }

  if (loading) {
    return <p>Loading cart...</p>;
  }

  return (
    <div className="shopping-cart">
      <h2>Your Shopping Cart</h2>
      {cart.length === 0 ? (
        <p>Your cart is empty</p>
      ) : (
        <ul>
          {cart.map((item) => (
            <li key={item.id}>
              {item.name} - ${item.price} x {item.quantity}
              <button onClick={() => removeFromCart(item.id)}>Remove</button>
            </li>
          ))}
        </ul>
      )}
      <div>
        <strong>Total: ${cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2)}</strong>
      </div>
    </div>
  );
}
```

## Summary

In this guide, we explored how to implement and manage sessions in Next.js applications. We covered:

- What sessions are and why they're important
- How to implement sessions using NextAuth.js
- How to create custom session management with Iron Session
- Security best practices for session management
- How to create protected routes
- A real-world example of session usage with a shopping cart

Sessions are a fundamental aspect of web authentication and user state management. By understanding how to properly implement and secure sessions in your Next.js applications, you can build robust authentication systems that provide a seamless user experience while maintaining security.

## Additional Resources

- [NextAuth.js Documentation](https://next-auth.js.org/)
- [Iron Session GitHub Repository](https://github.com/vvo/iron-session)
- [Next.js Authentication Documentation](https://nextjs.org/docs/authentication)
- [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)

## Exercises

1. Implement a session-based authentication system with login and registration using Iron Session.
2. Create a user preferences system that saves theme choices in the user's session.
3. Implement role-based access control using sessions to restrict access to certain pages.
4. Build a multi-step form wizard that saves progress in the session between steps.
5. Implement session timeout with an automatic logout feature and refreshable sessions.